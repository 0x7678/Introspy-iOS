#import "CallTracer.h"
#import "IntrospySQLiteStorage.h"


static NSString *preferenceFilePath = @"/private/var/mobile/Library/Preferences/com.isecpartners.introspy.plist";
static IntrospySQLiteStorage *traceStorage;


// Horrible h4ck to split Logos hooking code into separate files
#include "DataStorageHooks.xm"


%ctor {
	// Only hook Apps the user has selected in Introspy's settings panel
	NSString *appId = [[NSBundle mainBundle] bundleIdentifier];
	if (appId == nil) {
		return;
	}

    NSMutableDictionary* preferences = [[NSMutableDictionary alloc] initWithContentsOfFile:preferenceFilePath];
	NSString *appPreferenceKey = [NSString stringWithFormat:@"Settings-%@", appId];
	NSLog(@"APPNAME = %@", appId);

    if ([preferences objectForKey:appPreferenceKey]) { 

		// Initialize DB storage
		traceStorage = [[IntrospySQLiteStorage alloc] initWithDefaultDBFilePath];
		if (traceStorage != nil) {

	    	// Initialize hooks
	    	%init(DataStorage);
		}
		else {
			NSLog(@"Introspy - DB Initialization error; disabling hooks.");
		}
	}
	[preferences release];
}
