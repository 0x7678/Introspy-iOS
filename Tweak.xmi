
// Utility functions
#import "CallTracer.h"
#import "IntrospySQLiteStorage.h"
#import "PlistObjectConverter.h"
#import "CallStackInspector.h"


static NSString *preferenceFilePath = @"/private/var/mobile/Library/Preferences/com.isecpartners.introspy.plist";


// Hooks for C functions directly use MobileSubstrate
#import "hooks/KeyChainHooks.h"
#import "hooks/CCCryptorHooks.h"


// Hooks for ObjC methods rely on the Logos pre-processor
// H4ck to split Logos hooking code into separate files: we're including actual code, not headers
IntrospySQLiteStorage *traceStorage;


%group FileSystemHooks
#include "hooks/NSDataHooks.xm"
#include "hooks/NSFileHandleHooks.xm"
#include "hooks/NSFileManagerHooks.xm"
#include "hooks/NSInputStreamHooks.xm"
#include "hooks/NSOutputStreamHooks.xm"
%end

%group UserPreferencesHooks
#include "hooks/NSUserDefaultsHooks.xm"
%end



%ctor {
	NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
	// Only hook Apps the user has selected in Introspy's settings panel
	NSString *appId = [[NSBundle mainBundle] bundleIdentifier];
	if (appId == nil) {
		[pool drain];
		return;
	}
	
    NSMutableDictionary* preferences = [[NSMutableDictionary alloc] initWithContentsOfFile:preferenceFilePath];
	NSLog(@"APPNAME = %@", appId);
	id shouldHook = [preferences objectForKey:appId];
    if (shouldHook == nil) {
    	[preferences release];
		[pool drain];
		return;
	} 

    if ([shouldHook boolValue]) { 
		// Initialize DB storage
		// TODO: shouldLog = [preferences shouldLog]
		BOOL shouldLog = YES;
		traceStorage = [[IntrospySQLiteStorage alloc] initWithDefaultDBFilePathAndlogToConsole: shouldLog];
		if (traceStorage != nil) {

	    	// Initialize hooks
	    	// TODO: if Datastorage.is_enabled etc...
	    	%init(UserPreferencesHooks);
	    	%init(FileSystemHooks);
	    	[KeyChainHooks enableHooks];
	    	[CCCryptorHooks enableHooks];
		}
		else {
			NSLog(@"Introspy - DB Initialization error; disabling hooks.");
		}
	}
	[preferences release];
	[pool drain];
}
